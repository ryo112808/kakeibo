<!doctype html><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>家計簿</title>
<style>
body{font-family:system-ui;margin:0}.w{max-width:860px;margin:auto;padding:14px}
.c{border:1px solid #e6e6e6;border-radius:16px;padding:14px}
input,select,button{font:16px system-ui;padding:12px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box}
button{border:0;background:#111;color:#fff}.r{display:flex;gap:10px;margin:10px 0}.r>*{flex:1}
#bal{font-size:34px;font-weight:800;margin:2px 0 4px}small{color:#666}
.top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.top>*{width:auto}.pill{border:1px solid #ddd;border-radius:999px;padding:8px 12px}
.g{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
.h{font-size:12px;color:#666;text-align:center}
.d{border:1px solid #eee;border-radius:12px;padding:8px;min-height:68px;cursor:pointer}
.d b{font-size:13px} .sel{outline:2px solid #111}
.k{font-size:12px;margin-top:6px;color:#444}
.l{margin-top:10px;max-height:32vh;overflow:auto;border-top:1px solid #eee;padding-top:10px}
.it{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
</style>

<div class="w"><div class="c">
  <div><small>残高</small><div id="bal">¥0</div><small id="meta"></small></div>

  <div class="r">
    <input id="start" inputmode="numeric" placeholder="初期残高">
    <button id="set">セット</button>
  </div>

  <div class="r">
    <select id="cat"><option>交通</option><option>食事</option><option>その他</option></select>
    <input id="amt" inputmode="numeric" placeholder="金額">
  </div>

  <div class="r">
    <button id="in">収入＋(今日)</button>
    <button id="out" style="background:#b00020">支出−(今日)</button>
  </div>

  <div class="top">
    <button id="pm" style="background:#444;padding:10px 12px">←</button>
    <div class="pill" id="ym"></div>
    <button id="nm" style="background:#444;padding:10px 12px">→</button>
    <select id="f" style="min-width:120px">
      <option value="">全カテゴリ</option><option>交通</option><option>食事</option><option>その他</option>
    </select>
    <div class="pill" id="pick">全日</div>
    <button id="undo" style="background:#777;padding:10px 12px">戻す</button>
  </div>

  <div class="g" id="cal"></div>
  <div class="l" id="list"></div>
</div></div>

<script>
const $=id=>document.getElementById(id),K="kb_v2";
let s=0,log=[],cur=new Date(),pick="";
try{({s=0,log=[]}=JSON.parse(localStorage.getItem(K)||"{}"))}catch(e){}
const p=n=>String(n).padStart(2,"0");
const ymd=d=>d.getFullYear()+"-"+p(d.getMonth()+1)+"-"+p(d.getDate());
const yen=n=>"¥"+(Math.round(n)||0).toLocaleString("ja-JP");
const num=v=>{v=(v||"").toString().replace(/[^\d.-]/g,"");return v===""?NaN:+v}
const save=_=>localStorage.setItem(K,JSON.stringify({s,log}));
const sum=a=>a.reduce((t,x)=>t+x.v,0);
const fmt=v=>v?((v>0?"+":"−")+yen(Math.abs(v)).slice(1)):"";

function render(){
  const net=sum(log), bal=s+net;
  const ins=sum(log.filter(x=>x.v>0)), outs=-sum(log.filter(x=>x.v<0));
  $("bal").textContent=yen(bal);
  $("meta").textContent=`初期 ${yen(s)} / 収入 ${yen(ins)} / 支出 ${yen(outs)} / ${log.length}件`;

  const y=cur.getFullYear(), m=cur.getMonth();
  $("ym").textContent=y+"-"+p(m+1);

  const dow=["日","月","火","水","木","金","土"];
  let html=dow.map(x=>`<div class=h>${x}</div>`).join("");
  const first=new Date(y,m,1), startW=first.getDay(), days=new Date(y,m+1,0).getDate();
  for(let i=0;i<startW;i++) html+="<div></div>";

  const fc=$("f").value;
  for(let d=1; d<=days; d++){
    const ds=y+"-"+p(m+1)+"-"+p(d);
    const rows=log.filter(x=>x.d===ds && (!fc||x.c===fc));
    const v=sum(rows);
    html+=`<div class="d ${pick===ds?"sel":""}" data-d="${ds}"><b>${d}</b><div class=k>${v?("合計 "+fmt(v)):""}</div></div>`;
  }
  $("cal").innerHTML=html;
  [...document.querySelectorAll(".d")].forEach(el=>el.onclick=_=>{
    pick = (pick===el.dataset.d) ? "" : el.dataset.d; // 同じ日タップで解除
    $("pick").textContent=pick||"全日"; render();
  });

  const rows=log.filter(x=>(!pick||x.d===pick) && (!fc||x.c===fc)).slice().reverse();
  $("list").innerHTML=rows.length?rows.map(x=>{
    const sign=x.v>0?"+":"−";
    return `<div class=it><span>${x.d} / ${x.c}</span><span>${sign}${yen(Math.abs(x.v)).slice(1)}</span></div>`;
  }).join(""):"<small>カレンダーの日付で絞れる</small>";

  save();
}

function add(sign){
  const v=num($("amt").value); if(!Number.isFinite(v)) return;
  log.push({d:ymd(new Date()),c:$("cat").value,v:sign*Math.round(v)});
  $("amt").value=""; render();
}

$("set").onclick=_=>{const v=num($("start").value); if(!Number.isFinite(v)) return;
  s=Math.max(0,Math.round(v)); $("start").value=""; render();
};
$("in").onclick=_=>add(+1);
$("out").onclick=_=>add(-1);
$("pm").onclick=_=>{cur=new Date(cur.getFullYear(),cur.getMonth()-1,1); render();};
$("nm").onclick=_=>{cur=new Date(cur.getFullYear(),cur.getMonth()+1,1); render();};
$("f").onchange=_=>render();
$("undo").onclick=_=>{log.pop(); render();};
$("start").onkeydown=e=>e.key==="Enter"&&$("set").click();
$("amt").onkeydown=e=>e.key==="Enter"&&$("out").click(); // Enter=支出で即確定
render();
</script>
